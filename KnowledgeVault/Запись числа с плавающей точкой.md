[[Представление чисел]]
#ComputerScience/ComputerArchitecture

# Числа с плавающей точкой

В формате записи числа с плавающей точкой положение десятичного знака произвольно (в отличии от [[Запись числа с фиксированной точкой |чисел с фиксированной точкой]]) и задается с помощью показателя степени. 
Число с плавающей точкой разбито на три части: 
 - **мантиссу**, которая содержит соответствующие цифры числа по обе стороны от десятичной точки, 
 - **экспоненту** (порядок или показатель степени), определяющую, где в этой строке цифр находится десятичная точка
 - **бит знака,** который указывает, является значение положительным или отрицательным.
 
 Есть разные способы расположить эти три компонента в памяти, но наиболее распространенным стандартом является **IEEE-754**. Он определяет, что число в 32-разрядном формате записи выглядит следующим образом: старший бит — знак числа, за ним восемь знаков, определяющих значение экспоненты (порядка), а оставшиеся 23 бита отводятся для записи мантиссы.
 
 Значение v, представленное **знаковым битом s**,  **показателем степени e** и **мантиссой m**, равно:
 **v = (-1)^(s) · 2^(e–127) · (1 + m).**
Знаковый бит s имеет значение +1 или –1. Значение показателя e смещено на 127, чтобы можно было легко представить как положительные, так и отрицательные значения, не вводя дополнительный знак для показателя. Мантисса начинается с неявной 1, которая фактически не хранится в памяти, а остальные биты интерпретируются как обратные степени двойки. Таким образом, записанное значение равно 1 + m, где m — дробное значение, хранящееся в мантиссе.

s = 0 (указывает положительное число), e = 0b01111100 = 124 и m = 0b0100… = 0 · 2–1 + 1 · 2–2 = 1/4. Таким образом:
v = (-1)^s · 2^(e–127) · (1 + m) = 
= (+1) · 2^(124 – 127) · (1 + 1/4) =
= 2^(–3) · 5/4 = 1/8 · 5/4 =
= 0,125 · 1,25 = 0,156 25.

![[Pasted image 20220920165953.png]]

#### Зачем нужна неявная единица?
Неявная единица нужна чтобы устранить неоднозначность представлений числа в стандартной форме. Представление числа с ведущей неявной единицей называется **нормализированным**. Проблема, возникающая при этом - невозможность представить 0.

####  Специальные числа: ноль, бесконечность и неопределенность
В IEEE754 число «0» представляется значением с порядком, равным E=Emin-1 (для single это -127) и нулевой мантиссой. Введение нуля как самостоятельного числа (т.к. в нормализованном представлении нельзя представить ноль) позволило избежать многих странностей в арифметике. И хоть операции с нулем нужно обрабатывать отдельно, обычно они выполняются быстрее, чем с обычными числами.  
  
Также в IEEE754 предусмотрено представление для специальных чисел, работа с которыми вызывает исключение. К таким числам относится бесконечность (±∞) и неопределенность (NaN). Эти числа позволяет вернуть адекватное значение при переполнении. Бесконечности представлены как числа с порядком E=Emax+1 и нулевой мантиссой. Получить бесконечность можно при переполнении и при делении ненулевого числа на ноль. Бесконечность при делении разработчики определили исходя из существования пределов, когда делимое и делитель стремиться к какому-то числу. Соответственно, c/0 =±∞ (например, 3/0=+∞, а -3/0=-∞), так как если делимое стремиться к константе, а делитель к нулю, предел равен бесконечности. При 0/0 предел не существует, поэтому результатом будет неопределенность.  
  
**_Неопределенность_** или NaN (от not a number) – это представление, придуманное для того, чтобы арифметическая операция могла всегда вернуть какое-то не бессмысленное значение. В IEEE754 NaN представлен как число, в котором E=Emax+1, а мантисса не нулевая. Любая операция с NaN возвращает NaN. При желании в мантиссу можно записывать информацию, которую программа сможет интерпретировать. Стандартом это не оговорено и мантисса чаще всего игнорируется.  
  
Как можно получить NaN? Одним из следующих способов:  

-   ∞+(- ∞)
-   0 × ∞
-   0/0, ∞/∞
-   sqrt(x), где x<0

  
По определению NaN ≠ NaN, поэтому, для проверки значения переменной нужно просто сравнить ее с собой.

#### Знак нуля
Существуют два нуля, которые отличаются только знаком ([[Представление чисел#Прямое кодирование]]). Так, 3·(+0)=+0, а 3·(-0)=-0. Но при сравнении +0=-0. В стандарте знак сохранили умышленно, чтобы выражения, которые в результате переполнения или потери значимости превращаются в бесконечность или в ноль, при умножении и делении все же могли представить максимально корректный результат. Например, если бы у нуля не было знака, выражение 1/(1/x)=x не выполнялось бы верно при x=±∞, так как 1/∞ и 1/-∞ равны 0.  
  
Еще один пример:  
(+∞/0) + ∞ = +∞, тогда как (+∞/-0) +∞ = NaN  
  
Чем бесконечность в данном случае лучше, чем NaN? Тем, что если в арифметическом выражении появился NaN, результатом всего выражения всегда будет NaN. Если же в выражении встретилась бесконечность, то результатом может быть ноль, бесконечность или обычное число с плавающей запятой. Например, 1/∞=0.


#### Компромисс между величиной и точностью. 
Абсолютная точность числа с плавающей точкой увеличивается с уменьшением величины и наоборот. Это связано с тем, что в мантиссе имеется фиксированное количество битов и они должны быть каким-то образом разделены между целой и дробной частями числа. Чем больший процент битов используется для представления величины, тем меньшая их часть доступна для обеспечения точности дробной части.
Таким образом, мы всегда имеем одинаковое количество значащих цифр (на самом деле значащих битов) в числах с плавающей запятой, и показатель степени может использоваться для сдвига этих значащих битов в более высокие или более низкие диапазоны величины.
#### Субнормальные (Денормализированные числа)
Еще одна тонкость, на которую следует обратить внимание, заключается в том, что существует конечный разрыв между нулем и наименьшим ненулевым значением, которое мы можем представить с помощью записи с плавающей точкой (как описывалось до сих пор). 
Пусть имеем нормализованное представление с длиной мантиссы |M|=2 бита (+ один бит нормализации) и диапазоном значений порядка -1≤E≤2. В этом случае получим 16 чисел:
![[Pasted image 20220922161536.png]]
Видно, что расстояние от нуля до ближайшего числа (0 — 0,5) больше, чем от этого числа к следующему (0,5 — 0,625). Это значит, что разница двух любых чисел от 0,5 до 1 даст 0, даже если эти числа не равны. Что еще хуже, в пропасть между 0,5 и 0 попадает разница чисел, больших 1. Например, «1,5-1,25=0»

Разрыв вокруг 0 можно заполнить, используя расширение представления с плавающей точкой, известное как денормализованные (или субнормальные) значения. С этим расширением любое значение с плавающей точкой со значением показателя, равным 0 (–127 после смещения), интерпретируется как субнормальное число. Показатель степени обрабатывается так, как если бы он был равен 1, а не 0, а неявная ведущая 1, которая обычно находится перед битами мантиссы, заменяется на 0. Это приводит к заполнению разрыва между -FLT_MIN и + FLT_MIN линейной последовательностью равномерно распределенных субнормальных значений.

(-1)^s × 1.M × 2^E, если Emin≤E≤Emax (нормализованные числа)  
  
(-1)^s × 0.M × 2^Emin, если E=Emin-1. (денормализованные числа)  
  
Вернемся к примеру. Наш Emin=-1. Введем новое значение порядка, E=-2, при котором числа являются денормализованными. В результате получаем новое представление чисел:
![[Pasted image 20220922162940.png]]

Однако операции с субнормальными числами могут быть в разы (2 - 200 в зависимости от процессора) медленней 
#### Машинный эпсилон
Машинный эпсилон. Машинный эпсилон для конкретного представления с плавающей точкой определяется как наименьшее значение ε, которое удовлетворяет уравнению 1 + ε ≠ 1. Для числа с плавающей точкой IEEE-754 с 23-битной точностью значение ε равно 2–23, что составляет приблизительно 1,192 · 10–7. Наиболее значимая цифра ε попадает прямо в конец диапазона значащих цифр в значении 1,0, так что добавление любого значения, меньшего чем ε, к 1,0 не дает никакого эффекта. Другими словами, любые новые биты, добавляющие значение меньше ε, будут обрезаны, когда мы попытаемся поместить сумму в мантиссу, состоящую всего из 23 бит.
#### Единица на последнем месте (units in the last place, ULP).
Рассмотрим два числа с плавающей точкой, идентичных во всех отношениях, за исключением значения младшего разряда в их мантиссах. Говорят, что эти два значения различаются на одну единицу на последнем месте (1 ULP). Фактическое значение 1 ULP изменяется в зависимости от показателя степени. Например, число в записи с плавающей запятой 1.0f имеет несмещенный показатель степени 0 и мантиссу, в которой все биты равны 0, за исключением неявной начальной 1. При этом показателе степени 1 ULP равна машинному эпсилону (2–23). Если мы увеличим показатель степени на 1, получив значение 2,0f, значение 1 ULP станет равным двум значениям машинного эпсилона. И если показатель степени равен 2, что дает значение 4,0f, значение 1 ULP равно четырем значениям машинного эпсилона. В общем, если несмещенный показатель значения с плавающей точкой равен x, то 1 ULP = 2x · ε.